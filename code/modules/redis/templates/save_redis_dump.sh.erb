#!/usr/bin/env bash

SRC_DUMP_DIR="<%= @redis_src_dump_dir %>"
TARGET_DUMP_DIR="<%= @redis_target_dump_dir %>"
DB_FILENAME_PREFIX="<%= @redis_dump_filename_prefix %>"
DB_FILENAME_EXT="<%= @redis_dump_filename_ext %>"
MAX_DUMP_DURATION="<%= @redis_dump_max_retention %>"
APPENDONLY_FILENAME="<%= @redis_dump_appendonly_filename %>"
APPENDONLY_FILEPATH="${SRC_DUMP_DIR}/${APPENDONLY_FILENAME}"

CURRENT_DATE=$(date "+%Y%m%d%H%M%S")

SRC_DB_FILE="${SRC_DUMP_DIR}/${DB_FILENAME_PREFIX}.${DB_FILENAME_EXT}"
TARGET_DB_FILE="${TARGET_DUMP_DIR}/${DB_FILENAME_PREFIX}-${CURRENT_DATE}.${DB_FILENAME_EXT}"

cp "$SRC_DB_FILE" "$TARGET_DB_FILE"
[[ $? != "0" ]] && exit 1

rm -rf "$APPENDONLY_FILEPATH"
find "$TARGET_DUMP_DIR" -type f -iname "*.${DB_FILENAME_EXT}" -mtime +"$MAX_DUMP_DURATION" -exec rm -rf {} \; >/dev/null 2>&1 || :